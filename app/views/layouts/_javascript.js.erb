/* Volunteer new edit upload */
/* http://pastie.org/212866 */
(function($) {
    $.ajaxSetup({
	beforeSend: function(xhr) {
	    xhr.setRequestHeader("Accept", "text/javascript, text/html, application/xml, text/xml, */*");
	    xhr.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
	}
    });

    $().ajaxSend(function(event, request, settings) {
	if (typeof(AUTH_TOKEN) == "undefined") return;
	settings.data = settings.data || "";
	settings.data += ((settings.data == "") ? "" : "&") + "authenticity_token=" + encodeURIComponent(AUTH_TOKEN);
    });
})(jQuery);

/* Volunteer new edit upload */
/* pre-submit callback */
function showRequest(formData, jqForm, options) {
    var queryString = $.param(formData);
    // alert('About to submit: \n\n' + queryString);
    return true;
}

<% @cheese ||= [] -%>
<% @images ||= [] -%>
    var vImages=new Array("<%= @images.join("\", \"") %>");
var cheeseImages=new Array("<%= @cheese.join("\", \"") %>");
var curImage=0;

/* Volunteer new edit upload */
/* post-submit callback */
function showResponse(responseText, statusText)  {
/*  alert('status: ' + statusText + '\n\nresponseText: \n' + responseText +
        '\n\nThe output div should have already been updated with the responseT\
ext.');
*/
}

/* For upload form */
var form_options = {
    iframe:        true,         // Handle multipart data
    target:        '#image_selector',  // target element(s) to be updated
    beforeSubmit:  showRequest,  // pre-submit callback
    success:       showResponse  // post-submit callback
};

$(document).ready(function() {
// do stuff when DOM is ready
/* help: http://www.detacheddesigns.com/blog/blogSpecific.aspx?BlogId=62 */
    $("a.next_image").click(function(event){ showImage( nextImage() ); });
    $("a.prev_image").click(function(event){ showImage( prevImage() ); });

    $("a.choose").click(function(event){
	$.get('/workers/image_chooser',
	      <% if @worker %>{id: "<%= @worker.id %>"},<% else %>{}, <% end %> 
	      function(html) {
		  $('div#image_selector').html( html );
		  $("a.next_image").click(function(event){ showImage( nextImage() ); });
		  $("a.prev_image").click(function(event){ showImage( prevImage() ); });
       /* Add ajaxy input to load image filename to form */
		  $("a#upload_link").click(function(event){
		      $.ajax({
			  url: '/workers/upload_form',
			  type: 'GET',
			  dataType: 'html',
			  timeout: 1000,
			  error: function(){
			      alert('Error loading HTML document');
			  },
			  success: function(html){
			      $('div#image_selector').append( html );
			      $("#imageForm").ajaxForm(form_options);
			  }
		      });
		  });
		  $("a#cheese_link").click(function(event){
		      $.get('/workers/cheese_chooser',
			    <% if @worker %>{id: "<%= @worker.id %>"},<% else %>{}, <% end %> 
			    function(html) {
				$('div#image_selector').html( html );
				$("a.next_image").click(function(event){ showCheeseImage( nextCheeseImage() ); });
				$("a.prev_image").click(function(event){ showCheeseImage( prevCheeseImage() ); });
			    });
		  });

	      });
    });

  /* Add ajaxy input to load image filename to form */
    $("a#upload_link").click(function(event){
	$.ajax({
	    url: '/workers/upload_form',
	    type: 'GET',
	    dataType: 'html',
	    timeout: 1000,
	    error: function(){
		alert('Error loading HTML document');
	    },
	    success: function(html){
		$('div#image_selector').append( html );
		$("#imageForm").ajaxForm(form_options);
		$();
	    }
	});
    });
});
